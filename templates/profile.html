{% extends "base.html" %}

{% block title %}Profile - VulnApp{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">User Profile</h1>
    <p class="text-orange-600">⚠️ A03: XSS Vulnerability in profile display</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Profile Display -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Profile Information</h2>

        {% if user %}
        <div class="space-y-3">
            <div>
                <label class="text-sm font-medium text-gray-500">Username:</label>
                <p class="text-gray-900">{{ user[1] }}</p>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-500">Email:</label>
                <p class="text-gray-900">{{ user[3] }}</p>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-500">Role:</label>
                <span class="px-2 py-1 text-xs font-semibold rounded-full 
                           {% if user[4] == 'admin' %}bg-red-100 text-red-800{% else %}bg-green-100 text-green-800{% endif %}">
                    {{ user[4] }}
                </span>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-500">Profile Description:</label>
                <!-- A03: VULNERABILITY - XSS via unsafe rendering -->
                <div class="mt-1 p-3 bg-gray-50 rounded border">
                    {{ user[5]|safe }}
                </div>
            </div>
        </div>
        {% endif %}

        <div class="mt-6 bg-orange-50 p-4 rounded">
            <h3 class="text-sm font-semibold text-orange-800">XSS Vulnerability:</h3>
            <p class="text-xs text-orange-700 mt-1">
                The profile description is rendered without proper escaping, allowing stored XSS attacks.
            </p>
        </div>
    </div>

    <!-- Profile Update Form -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Update Profile</h2>

        <form id="profileForm">
            <div class="mb-4">
                <label for="profile" class="block text-sm font-medium text-gray-700">Profile Description</label>
                <textarea id="profile" name="profile" rows="4" 
                          placeholder="Enter your profile description..."
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">{{ user[5] if user else '' }}</textarea>
                <p class="text-xs text-orange-500 mt-1">⚠️ HTML and JavaScript will be executed (XSS vulnerability)</p>
            </div>

            <button type="submit" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">
                Update Profile
            </button>
        </form>

        <!-- XSS Test Cases -->
        <div class="mt-6 bg-red-50 border border-red-200 rounded p-4">
            <h3 class="text-sm font-semibold text-red-800">XSS Test Payloads:</h3>
            <div class="text-xs text-red-700 mt-2 space-y-1">
                <button onclick="setPayload('<script>alert(\'XSS Attack!\');</script>')" 
                        class="block text-left hover:bg-red-100 p-1 rounded">
                    <code>&lt;script&gt;alert('XSS Attack!');&lt;/script&gt;</code>
                </button>
                <button onclick="setPayload('<img src=x onerror=alert(\'XSS\')>')" 
                        class="block text-left hover:bg-red-100 p-1 rounded">
                    <code>&lt;img src=x onerror=alert('XSS')&gt;</code>
                </button>
                <button onclick="setPayload('<svg onload=alert(\'XSS\')>')" 
                        class="block text-left hover:bg-red-100 p-1 rounded">
                    <code>&lt;svg onload=alert('XSS')&gt;</code>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function setPayload(payload) {
    document.getElementById('profile').value = payload;
}

document.getElementById('profileForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch('{{ url_for("update_profile") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Profile updated successfully!');
            location.reload();
        } else {
            alert('Update failed: ' + data.message);
        }
    });
});
</script>
{% endblock %}